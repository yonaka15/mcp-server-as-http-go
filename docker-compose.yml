version: "3.8"

services:
  # Docker-in-Docker service
  docker-daemon:
    image: docker:26-dind
    container_name: mcp-docker-daemon
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=
    volumes:
      - mcp_docker_data:/var/lib/docker
    networks:
      - mcp_network
    command: ["dockerd", "--host=tcp://0.0.0.0:2376", "--tls=false"]
    # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«
    # healthcheck:
    #   test: ["CMD", "docker", "version"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3

  # MCP HTTP Server
  mcp-http-server:
    build:
      context: ..
      dockerfile: mcp-server-as-go/Dockerfile
    container_name: mcp-http-server
    ports:
      - "${PORT:-3000}:${PORT:-3000}"

    # ğŸš€ åŠ¹ç‡çš„ãªç’°å¢ƒå¤‰æ•°ç®¡ç†: .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
    env_file:
      - .env

    environment:
      # ã‚³ãƒ³ãƒ†ãƒŠå›ºæœ‰ã®è¨­å®šã®ã¿å€‹åˆ¥æŒ‡å®š
      # Docker (DinDçµŒç”±) - ã‚³ãƒ³ãƒ†ãƒŠé–“é€šä¿¡ç”¨ã®å›ºå®šè¨­å®š
      - DOCKER_HOST=tcp://docker-daemon:2376

      # ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã®ç„¡åŠ¹åŒ– - ã‚³ãƒ³ãƒ†ãƒŠãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›ºæœ‰
      - HTTP_PROXY=
      - HTTPS_PROXY=
      - http_proxy=
      - https_proxy=
      - NO_PROXY=localhost,127.0.0.1,docker.internal,*.docker.internal,docker-daemon
      - no_proxy=localhost,127.0.0.1,docker.internal,*.docker.internal,docker-daemon

    volumes:
      - mcp_cache:/tmp/mcp-servers:rw

    depends_on:
      - docker-daemon
    # condition: service_healthy ã‚’å‰Šé™¤

    networks:
      - mcp_network

    restart: unless-stopped

    # Lightweight resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.3"
        reservations:
          memory: 128M
          cpus: "0.1"

volumes:
  mcp_cache:
    driver: local
  mcp_docker_data:
    driver: local

networks:
  mcp_network:
    driver: bridge
